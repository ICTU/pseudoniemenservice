name: Pseudoniemen Service

on:
  push:
    branches: [ "development" ]
  pull_request:
    branches: [ "development" ]

jobs:
#  test:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#        with:
#          fetch-depth: 0
#
#      - name: Setup  Java
#        uses: actions/setup-java@v4
#        with:
#          java-version: '21'
#          distribution: 'liberica'
#          cache: maven
#
#      - name: Test with Maven
#        run: mvn -Ppitest -B verify
  
  build:
    if: github.event_name != 'pull_request'
    strategy:
      fail-fast: true
      matrix:
        platform: [amd64, arm64]
        include:
          - platform: amd64
            runner: ubuntu-latest
            javaarch: x64
          - platform: arm64
            runner: buildjet-4vcpu-ubuntu-2204-arm
            javaarch: aarch64
    runs-on: ${{ matrix.runner }}

#    needs:
#      - test

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: print arch
        run: uname -a

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io/bhuism/pseudoniemenservice
          username: bhuism
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/bhuism/pseudoniemenservice

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'liberica'
          architecture: ${{ matrix.javaarch }}
          java-version: '21'
          cache: 'maven'

      - name: Buid and publish image via spring build-image
        run: |
          mvn --no-transfer-progress -B -DskipTests spring-boot:build-image -Dspring-boot.build-image.imagePlatform=linux/${{ matrix.platform }} -Dspring-boot.build-image.imageName=ghcr.io/bhuism/pseudoniemenservice:latest-${{ matrix.platform }}

      - name: Push
        run: |
          docker push ghcr.io/bhuism/pseudoniemenservice:latest-${{ matrix.platform }}

#      - name: Set up Pack
#        uses: buildpacks/github-actions/setup-pack@v5.8.6
#        with:
#          pack-version: 0.35.1

#      - name: Build and publish image via pack
#        run: |
#          pack build ghcr.io/bhuism/pseudoniemenservice:latest-${{ matrix.platform }} \
#            --builder docker.io/paketobuildpacks/builder-jammy-buildpackless-tiny \
#            --buildpack gcr.io/paketo-buildpacks/java-native-image \
#            --publish \
#            --platform linux/${{ matrix.platform }} \
#            --env BP_NATIVE_IMAGE=true \
#            --env BP_MAVEN_ACTIVE_PROFILES=native


  manifest-and-push:
    runs-on: ubuntu-latest
    needs: build
    if: success()
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io/bhuism/pseudoniemenservice
          username: bhuism
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: merge containers and push
        run: |
          docker manifest create ghcr.io/bhuism/pseudoniemenservice:latest \
            ghcr.io/bhuism/pseudoniemenservice:latest-amd64 ghcr.io/bhuism/pseudoniemenservice:latest-arm64
          docker manifest push ghcr.io/bhuism/pseudoniemenservice:latest
